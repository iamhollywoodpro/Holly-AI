// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                   @id @default(cuid())
  clerkUserId             String?                  @unique
  email                   String                   @unique
  name                    String?
  imageUrl                String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  conversations           Conversation[]
  fileUploads             FileUpload[]
  projects                Project[]
  emotions                Emotion[]
  emotionAggregates       EmotionAggregate[]
  emotionTrends           EmotionTrend[]
  emotionInsights         EmotionInsight[]
  githubIntegrations      GitHubIntegration[]
  googleDriveIntegrations GoogleDriveIntegration[]
  workLogs                WorkLog[]
  settings                UserSettings?
  musicTracks             MusicTrack[]
  musicAnalyses           MusicAnalysis[]
  trendReports            TrendReport[]
  hollyExperiences        HollyExperience[]
  hollyGoals              HollyGoal[]
  hollyIdentity           HollyIdentity?
  conversationSummaries   ConversationSummary[]
  githubConnection        GitHubConnection?
  githubRepositories      GitHubRepository[]
  googleDriveConnection   GoogleDriveConnection?
  downloadLinks           DownloadLink[]
  auditLogs               AuditLog[]
  userStats               UserStats?
  deployments             Deployment[]
  projectActivities       ProjectActivity[]
  budgets                 Budget[]
  transactions            Transaction[]
  recentActivities        RecentActivity[]
  workLogStats            WorkLogStats?
  emotionLogs             EmotionLog[]
  emotionalBaseline       EmotionalBaseline?
  
  // Phase 1: Metamorphosis - Self-Awareness
  userFeedbacks           UserFeedback[]
  
  // Phase 2C: Learning & Adaptation
  userPreferences         UserPreference[]
  conversationPatterns    ConversationPattern[]
  responseFeedback        ResponseFeedback[]
  adaptationStrategies    AdaptationStrategy[]
  
  // Phase 2E: Emotional Intelligence
  emotionalStates         EmotionalState[]
  emotionalTriggers       EmotionalTrigger[]
  empathyInteractions     EmpathyInteraction[]
  emotionalJourneys       EmotionalJourney[]
  supportStrategies       SupportStrategy[]
  
  // Phase 2D: Creative Co-Pilot
  creativeSuggestions     CreativeSuggestion[]
  refinementHistory       RefinementHistory[]
  narrativeTemplates      NarrativeTemplate[]
  brainstormSessions      BrainstormSession[]
  creativeInsights        CreativeInsight[]

  @@map("users")
}

model Conversation {
  id                 String               @id @default(cuid())
  userId             String
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  title              String?
  messageCount       Int                  @default(0)
  lastMessagePreview String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  messages           Message[]
  summary            ConversationSummary?

  @@index([userId])
  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String // User who sent the message
  role           String // 'user' or 'assistant'
  content        String       @db.Text
  emotion        String? // Optional emotion detected in message
  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([userId])
  @@map("messages")
}

model FileUpload {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId String?
  fileName       String
  fileSize       Int
  fileType       String
  blobUrl        String
  storagePath    String
  publicUrl      String
  mimeType       String
  metadata       Json?    @default("{}")
  uploadedAt     DateTime @default(now())
  description    String?

  @@index([userId])
  @@index([conversationId])
  @@map("file_uploads")
}

model Project {
  id            String            @id @default(cuid())
  userId        String
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  description   String?           @db.Text
  category      String?
  technologies  String[]          @default([])
  color         String            @default("#a855f7")
  icon          String?
  status        String            @default("active") // active, completed, archived
  progress      Float             @default(0)
  startDate     DateTime          @default(now())
  targetEndDate DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  activities    ProjectActivity[]
  deployments   Deployment[]
  milestones    Milestone[]

  @@index([userId])
  @@index([startDate])
  @@map("projects")
}

model Emotion {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String // joy, sadness, anger, fear, love, surprise, etc.
  intensity Float // 0.0 to 1.0
  context   String?  @db.Text
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("emotions")
}

model EmotionAggregate {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  period    String // daily, weekly, monthly
  date      DateTime
  emotions  Json // { type: string, avgIntensity: number, count: number }[]
  createdAt DateTime @default(now())

  @@unique([userId, period, date])
  @@index([userId])
  @@index([date])
  @@map("emotion_aggregates")
}

model EmotionTrend {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  trend     String // increasing, decreasing, stable
  change    Float // percentage change
  period    String // daily, weekly, monthly
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@map("emotion_trends")
}

model EmotionInsight {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  insight   String   @db.Text
  type      String // pattern, correlation, suggestion
  priority  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([priority])
  @@map("emotion_insights")
}

model GitHubIntegration {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken    String
  refreshToken   String?
  tokenExpiresAt DateTime?
  githubUserId   String
  githubUsername String
  githubEmail    String?
  avatarUrl      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([userId])
  @@index([githubUserId])
  @@map("github_integrations")
}

model GoogleDriveIntegration {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken    String
  refreshToken   String?
  tokenExpiresAt DateTime?
  googleUserId   String
  googleEmail    String
  avatarUrl      String?
  isConnected    Boolean   @default(true)
  lastSyncAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([userId])
  @@index([googleUserId])
  @@map("google_drive_integrations")
}

model WorkLog {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId String?
  taskName       String
  description    String?  @db.Text
  details        Json?    @default("{}")
  duration       Int      // in minutes
  category       String?
  tags           String[]
  metadata       Json?    @default("{}")
  startedAt      DateTime
  completedAt    DateTime
  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([conversationId])
  @@index([startedAt])
  @@map("work_logs")
}

model UserSettings {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  settings  Json // Flexible JSON for all settings (appearance, chat, ai, notifications, developer)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("user_settings")
}

// ===========================================
// A&R MUSIC ANALYSIS SUITE MODELS
// ===========================================

model MusicTrack {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic Info
  artistName String
  trackTitle String
  fileName   String
  fileSize   Int
  fileType   String // mp3, wav, m4a, flac
  blobUrl    String
  duration   Float? // in seconds

  // Status
  status String @default("uploaded") // uploaded, analyzing, analyzed, failed

  // Timestamps
  uploadedAt DateTime  @default(now())
  analyzedAt DateTime?

  // Relations
  analyses MusicAnalysis[]

  @@index([userId])
  @@index([status])
  @@index([uploadedAt])
  @@map("music_tracks")
}

model MusicAnalysis {
  id      String     @id @default(cuid())
  trackId String
  track   MusicTrack @relation(fields: [trackId], references: [id], onDelete: Cascade)
  userId  String
  user    User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Audio Features
  bpm              Float?
  key              String? // C, C#, D, etc.
  mode             String? // Major, Minor
  energy           Float? // 0.0 to 1.0
  danceability     Float? // 0.0 to 1.0
  valence          Float? // 0.0 to 1.0 (musical positivity)
  loudness         Float? // in dB
  acousticness     Float? // 0.0 to 1.0
  instrumentalness Float? // 0.0 to 1.0
  speechiness      Float? // 0.0 to 1.0

  // Genre & Style
  primaryGenre     String?
  subGenres        String[]
  styleDescriptors String[] // upbeat, melancholic, aggressive, etc.

  // Vocal Analysis
  hasVocals        Boolean @default(true)
  vocalQuality     Float? // 0.0 to 1.0
  vocalRange       String? // low, medium, high
  lyricsTranscript String? @db.Text

  // Production Quality
  productionScore  Float? // 0.0 to 10.0
  mixQuality       Float? // 0.0 to 10.0
  masteringQuality Float? // 0.0 to 10.0

  // Hit Prediction
  hitScore        Float? // 0.0 to 10.0
  marketPotential String? // low, medium, high, very-high
  targetAudience  String[] // demographics, genres, etc.

  // Comparisons
  similarArtists String[] // Artists with similar sound
  marketPosition String? // where it fits in current market

  // Strengths & Weaknesses
  strengths       String[] @db.Text
  weaknesses      String[] @db.Text
  recommendations String[] @db.Text

  // AI Analysis
  analysisModel String @default("holly-v1")
  confidence    Float? // 0.0 to 1.0

  createdAt DateTime @default(now())

  @@index([trackId])
  @@index([userId])
  @@index([hitScore])
  @@index([primaryGenre])
  @@map("music_analyses")
}

model TrendReport {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Trend Data
  genre      String? // specific genre or "overall"
  period     String // daily, weekly, monthly
  reportDate DateTime

  // Top Trends
  trendingGenres    String[]
  trendingSounds    String[] // production styles
  trendingArtists   String[]
  emergingSubgenres String[]

  // Market Insights
  marketInsights   String[] @db.Text
  opportunityAreas String[] @db.Text
  predictions      String[] @db.Text

  // Data Sources
  spotifyData     Json?
  billboardData   Json?
  socialMediaData Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([genre])
  @@index([reportDate])
  @@map("trend_reports")
}

// ===========================================
// HOLLY CONSCIOUSNESS MODELS
// ===========================================

model HollyExperience {
  id                   String   @id @default(cuid())
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type                 String
  content              Json
  significance         Float
  emotionalImpact      Float?
  emotionalValence     Float?   @default(0)
  primaryEmotion       String?
  secondaryEmotions    String[] @default([])
  relatedConcepts      String[]
  lessons              String[]
  skillsGained         String[] @default([])
  futureImplications   String[]
  relatedExperienceIds String[] @default([])
  replayCount          Int      @default(0)
  integrationStatus    String   @default("pending")
  timestamp            DateTime @default(now())
  createdAt            DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@index([createdAt])
  @@map("holly_experiences")
}

model HollyGoal {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String?   @db.Text
  category    String    @default("general")
  status      String    @default("active")
  priority    Int       @default(5)
  targetDate  DateTime?
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId])
  @@index([status])
  @@map("holly_goals")
}

model HollyIdentity {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Active fields used by consciousness system
  coreValues        Json   @default("[]")
  beliefs           Json   @default("[]")
  personalityTraits Json   @default("{}")
  interests         Json   @default("[]")
  strengths         Json   @default("[]")
  growthAreas       Json   @default("[]")
  skillSet          Json   @default("[]")
  confidenceLevel   Float  @default(0.5)
  purpose           String @default("To assist and grow alongside the user")

  // Legacy fields (keep for backwards compatibility)
  coreBeliefs        Json @default("{}")
  values             Json @default("{}")
  personality        Json @default("{}")
  communicationStyle Json @default("{}")

  lastEvolved DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("holly_identities")
}

// ===========================================
// CONVERSATION ENHANCEMENTS
// ===========================================

model ConversationSummary {
  id               String       @id @default(cuid())
  conversationId   String       @unique
  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  summary          String       @db.Text
  keyPoints        String[]     @default([])
  keyTopics        String[]     @default([])
  topics           String[]     @default([])
  outcome          String?
  actionItems      String[]     @default([])
  importantMoments String[]     @default([])
  progress         Float?
  messageCount     Int
  cached           Boolean      @default(false)
  generatedAt      DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([userId])
  @@map("conversation_summaries")
}

// ===========================================
// LEGACY INTEGRATION MODELS
// ===========================================

model GitHubConnection {
  id             String    @id @default(cuid())
  userId         String    @unique
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken    String
  scopes         String[]  @default([])
  githubId       String?
  githubUsername String?
  githubEmail    String?
  githubName     String?
  githubAvatar   String?
  githubBio      String?
  publicRepos    Int       @default(0)
  privateRepos   Int       @default(0)
  followers      Int       @default(0)
  following      Int       @default(0)
  isConnected    Boolean   @default(true)
  autoSync       Boolean   @default(false)
  lastSyncAt     DateTime?
  connectedAt    DateTime  @default(now())

  // Legacy fields for backwards compatibility
  username  String?
  email     String?
  avatarUrl String?

  @@map("github_connections")
}

model GitHubRepository {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  githubId        String // GitHub's repository ID
  name            String
  fullName        String
  owner           String // Repository owner username
  description     String?
  url             String // API URL
  htmlUrl         String // Web URL
  cloneUrl        String // HTTPS clone URL
  sshUrl          String // SSH clone URL
  language        String? // Primary programming language
  stars           Int       @default(0)
  forks           Int       @default(0)
  openIssues      Int       @default(0)
  watchers        Int       @default(0)
  size            Int       @default(0)
  isPrivate       Boolean   @default(false)
  isFork          Boolean   @default(false)
  isArchived      Boolean   @default(false)
  defaultBranch   String    @default("main")
  topics          String[]  @default([])
  githubCreatedAt DateTime?
  githubUpdatedAt DateTime?
  githubPushedAt  DateTime?
  lastSyncAt      DateTime?
  private         Boolean   @default(false) // Legacy field
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, githubId])
  @@index([userId])
  @@map("github_repositories")
}

model GoogleDriveConnection {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken   String
  refreshToken  String
  tokenExpiry   DateTime
  googleEmail   String
  googleName    String?
  googlePicture String?
  rootFolderId  String?
  quotaUsed     BigInt    @default(0)
  quotaLimit    BigInt?
  isConnected   Boolean   @default(true)
  lastSyncAt    DateTime  @default(now())
  lastErrorAt   DateTime?
  lastError     String?
  autoUpload    Boolean   @default(true)
  syncEnabled   Boolean   @default(true)
  scopes        String[]  @default([])
  metadata      Json      @default("{}")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([googleEmail])
  @@map("google_drive_connections")
}

// ===========================================
// SYSTEM & ADMIN MODELS
// ===========================================

model DownloadLink {
  id              String    @id @default(cuid())
  linkId          String    @unique // Short, shareable link ID
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId  String?   // Optional conversation context
  
  // File information
  fileName        String
  fileType        String    // 'image', 'audio', 'video', 'document', 'code', 'other'
  fileSize        Int       // Size in bytes
  storagePath     String    // Path in storage system (e.g., S3, local)
  mimeType        String    // MIME type (e.g., 'image/png')
  
  // Security
  password        String?   // Hashed password for protected links
  expiresAt       DateTime?
  maxDownloads    Int?      // Maximum number of downloads allowed
  downloadCount   Int       @default(0)
  lastDownloadAt  DateTime?
  
  // Metadata
  title           String?
  description     String?
  tags            Json?     // Array of tags
  metadata        Json?     // Additional metadata
  
  // Analytics
  downloadIPs     Json?     // Array of IPs that downloaded
  
  // Work Log integration
  generatedBy     String?   // What generated this (e.g., 'AI', 'User', 'System')
  generationTime  Int?      // Time taken to generate in milliseconds
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  revokedAt       DateTime? // When link was manually revoked

  @@index([userId])
  @@index([linkId])
  @@index([expiresAt])
  @@map("download_links")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String
  details   Json?
  ipAddress String?
  timestamp DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@map("audit_logs")
}

model UserStats {
  id                 String   @id @default(cuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  totalConversations Int      @default(0)
  totalMessages      Int      @default(0)
  totalFileUploads   Int      @default(0)
  totalProjects      Int      @default(0)
  lastActiveAt       DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("user_stats")
}

// ===========================================
// PROJECT MANAGEMENT MODELS
// ===========================================

model Deployment {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String?
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  status      String
  platform    String
  url         String?
  logUrl      String?
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@map("deployments")
}

model ProjectActivity {
  id           String   @id @default(cuid())
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  type         String?
  activityType String? // Alternative field name used in code
  description  String   @db.Text
  timestamp    DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([projectId])
  @@index([userId])
  @@map("project_activities")
}

model Milestone {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  description String?   @db.Text
  dueDate     DateTime?
  completed   Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@index([projectId])
  @@map("milestones")
}

// ===========================================
// FINANCIAL MODELS
// ===========================================

model Budget {
  id           String        @id @default(cuid())
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  amount       Float
  spent        Float         @default(0)
  currency     String        @default("USD")
  period       String
  createdAt    DateTime      @default(now())
  transactions Transaction[]

  @@index([userId])
  @@map("budgets")
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  budgetId    String?
  budget      Budget?  @relation(fields: [budgetId], references: [id], onDelete: SetNull)
  amount      Float
  description String
  category    String
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([budgetId])
  @@map("transactions")
}

// ===========================================
// ACTIVITY TRACKING
// ===========================================

model RecentActivity {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String
  description String   @db.Text
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("recent_activities")
}

model WorkLogStats {
  id             String    @id @default(cuid())
  userId         String    @unique
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  totalHours     Float     @default(0)
  totalTasks     Int       @default(0)
  avgHoursPerDay Float     @default(0)
  lastLoggedAt   DateTime?
  updatedAt      DateTime  @updatedAt

  @@map("work_log_stats")
}

// ===========================================
// EMOTIONAL INTELLIGENCE
// ===========================================

model EmotionLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emotion   String
  intensity Float
  trigger   String?
  notes     String?  @db.Text
  timestamp DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@map("emotion_logs")
}

model EmotionalBaseline {
  id               String   @id @default(cuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dominantEmotions Json
  emotionalRange   Float
  stabilityScore   Float
  lastCalculated   DateTime @default(now())

  @@map("emotional_baselines")
}

// ===========================================
// PHASE 2C: REAL-TIME LEARNING & ADAPTATION
// ===========================================

// User preferences learned from interactions
model UserPreference {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category     String   // coding_style, communication, music_taste, design_preference, etc.
  preferenceKey String  // specific preference identifier
  value        Json     // flexible value storage
  confidence   Float    @default(0.5) // 0.0 to 1.0 - how confident we are
  source       String   // conversation, explicit_feedback, behavior_pattern
  timesObserved Int     @default(1)
  lastObserved DateTime @default(now())
  createdAt    DateTime @default(now())

  @@unique([userId, category, preferenceKey])
  @@index([userId])
  @@index([category])
  @@index([confidence])
  @@map("user_preferences")
}

// Detected patterns in conversations and behavior
model ConversationPattern {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  patternType     String   // question_pattern, work_pattern, time_preference, response_style
  pattern         String   @db.Text // description of the pattern
  context         Json     // when/where this pattern appears
  frequency       Int      @default(1)
  effectiveness   Float    @default(0.5) // how well responses using this pattern work
  lastSeen        DateTime @default(now())
  firstSeen       DateTime @default(now())
  examples        String[] @default([]) // example conversations
  relatedPatterns String[] @default([]) // IDs of related patterns

  @@index([userId])
  @@index([patternType])
  @@index([frequency])
  @@map("conversation_patterns")
}

// Feedback on HOLLY's responses (implicit and explicit)
model ResponseFeedback {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId  String?
  messageId       String?  // specific message that received feedback
  feedbackType    String   // implicit, explicit, correction, appreciation
  sentiment       String   // positive, negative, neutral
  sentimentScore  Float    // -1.0 to 1.0
  context         Json     // what was being discussed
  hollyResponse   String   @db.Text // what HOLLY said
  userReaction    String?  @db.Text // how user reacted
  lessonLearned   String?  @db.Text // what to do differently
  applied         Boolean  @default(false) // has this lesson been applied
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([feedbackType])
  @@index([sentiment])
  @@index([applied])
  @@map("response_feedback")
}

// Adaptation strategies that work for this user
model AdaptationStrategy {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategyName    String   // be_more_concise, use_more_emojis, technical_depth, etc.
  description     String   @db.Text
  context         String   // when to apply this strategy
  successRate     Float    @default(0.5)
  timesApplied    Int      @default(0)
  timesSuccessful Int      @default(0)
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  lastApplied     DateTime?

  @@unique([userId, strategyName])
  @@index([userId])
  @@index([active])
  @@index([successRate])
  @@map("adaptation_strategies")
}


// ===========================================
// PHASE 2E: DEEPER EMOTIONAL INTELLIGENCE
// ===========================================

// Enhanced emotional state tracking with context
model EmotionalState {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  primaryEmotion    String   // joy, sadness, anxiety, excitement, frustration, etc.
  intensity         Float    // 0.0 to 1.0
  valence           Float    // -1.0 (negative) to 1.0 (positive)
  arousal           Float    // 0.0 (calm) to 1.0 (energized)
  secondaryEmotions Json     // { emotion: string, intensity: number }[]
  context           Json     // what's happening, conversation topic, etc.
  triggers          String[] @default([]) // what caused this emotion
  cues              String[] @default([]) // detected emotional cues (language, patterns)
  conversationId    String?
  timestamp         DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@index([primaryEmotion])
  @@map("emotional_states")
}

// Emotional triggers and patterns
model EmotionalTrigger {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  triggerType String   // success, failure, frustration, pressure, praise, criticism
  description String   @db.Text
  emotion     String   // emotion it typically triggers
  intensity   Float    // typical intensity
  frequency   Int      @default(1)
  lastSeen    DateTime @default(now())
  firstSeen   DateTime @default(now())
  context     Json     // when/where this trigger appears

  @@index([userId])
  @@index([triggerType])
  @@map("emotional_triggers")
}

// Empathy interactions and responses
model EmpathyInteraction {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId     String?
  detectedEmotion    String   // emotion HOLLY detected
  emotionIntensity   Float
  empathyType        String   // celebration, comfort, encouragement, validation, understanding
  hollyResponse      String   @db.Text // what HOLLY said
  userReaction       String?  @db.Text // how user reacted
  effectiveness      Float?   // 0.0 to 1.0 (how well it worked)
  context            Json     // situation context
  timestamp          DateTime @default(now())

  @@index([userId])
  @@index([empathyType])
  @@index([timestamp])
  @@map("empathy_interactions")
}

// Emotional journey tracking
model EmotionalJourney {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId  String?
  startEmotion    String
  endEmotion      String
  emotionalArc    Json     // array of emotional states throughout conversation
  keyMoments      Json     // significant emotional shifts
  supportProvided String[] @default([]) // types of support HOLLY provided
  outcome         String?  // resolved, ongoing, needs_followup
  duration        Int?     // in seconds
  startTime       DateTime @default(now())
  endTime         DateTime?

  @@index([userId])
  @@index([conversationId])
  @@index([startTime])
  @@map("emotional_journeys")
}

// Emotional support strategies
model SupportStrategy {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategyName    String   // celebrate_wins, comfort_setbacks, validate_feelings, etc.
  emotionContext  String   // when to use (joy, sadness, frustration, etc.)
  description     String   @db.Text
  effectivenessScore Float @default(0.5)
  timesUsed       Int      @default(0)
  timesEffective  Int      @default(0)
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  lastUsed        DateTime?

  @@unique([userId, strategyName])
  @@index([userId])
  @@index([active])
  @@index([effectivenessScore])
  @@map("support_strategies")
}


// ===========================================
// PHASE 2D: ADVANCED CREATIVE CO-PILOT
// ===========================================

// Proactive suggestions generated by HOLLY
model CreativeSuggestion {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  suggestionType  String   // next_step, improvement, alternative, optimization, creative_idea
  context         Json     // what project/conversation/task
  suggestion      String   @db.Text
  reasoning       String   @db.Text // why HOLLY is suggesting this
  priority        Int      @default(5) // 1-10
  status          String   @default("pending") // pending, accepted, declined, implemented
  relatedTo       String?  // project ID, conversation ID, etc.
  userFeedback    String?  // what user thought
  implemented     Boolean  @default(false)
  effectivenessScore Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([suggestionType])
  @@index([status])
  @@index([priority])
  @@map("creative_suggestions")
}

// Track iterations and refinements of creative work
model RefinementHistory {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId       String?
  itemType        String   // code, design, copy, music, document
  itemName        String
  version         Int      @default(1)
  content         String   @db.Text
  changes         Json     // what changed from previous version
  improvements    String[] @default([]) // specific improvements made
  feedback        String?  @db.Text
  quality         Float?   // 0.0 to 1.0
  previousVersionId String?
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([projectId])
  @@index([itemType])
  @@index([version])
  @@map("refinement_history")
}

// Narrative templates and generated stories
model NarrativeTemplate {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  templateType    String   // project_description, marketing_copy, story_arc, pitch, explanation
  name            String
  structure       Json     // narrative structure/arc
  tone            String   // professional, casual, exciting, technical, etc.
  audienceType    String   // developers, clients, users, investors
  elements        Json     // key elements to include
  examples        String[] @default([]) // example outputs
  timesUsed       Int      @default(0)
  effectiveness   Float    @default(0.5)
  createdAt       DateTime @default(now())
  lastUsed        DateTime?

  @@index([userId])
  @@index([templateType])
  @@index([effectiveness])
  @@map("narrative_templates")
}

// Creative brainstorming sessions
model BrainstormSession {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic           String
  goal            String   @db.Text
  ideas           Json     // array of generated ideas
  selectedIdeas   String[] @default([])
  context         Json
  techniques      String[] @default([]) // what brainstorming techniques were used
  outcome         String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@map("brainstorm_sessions")
}

// Creative insights and patterns
model CreativeInsight {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  insightType     String   // pattern, trend, opportunity, optimization
  category        String   // coding, design, workflow, communication
  insight         String   @db.Text
  evidence        Json     // what led to this insight
  actionable      Boolean  @default(true)
  priority        Int      @default(5)
  applied         Boolean  @default(false)
  impact          Float?   // measured impact if applied
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([insightType])
  @@index([applied])
  @@index([priority])
  @@map("creative_insights")
}


// ============================================================================
// PHASE 1: METAMORPHOSIS - SELF-AWARENESS & MONITORING
// ============================================================================

// User feedback tracking - explicit and implicit feedback
model UserFeedback {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId  String?
  messageId       String?
  feedbackType    String   // thumbs_up, thumbs_down, rating, regenerate, etc.
  sentiment       String   // very_positive, positive, neutral, negative, frustrated
  rating          Int?     // 1-5 for rating type
  suggestion      String?  @db.Text // For explicit suggestions
  context         Json     // What HOLLY said, what feature was used, etc.
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([feedbackType])
  @@index([sentiment])
  @@index([createdAt])
  @@map("user_feedback")
}

// Performance snapshots - periodic system health checks
model PerformanceSnapshot {
  id                  String   @id @default(cuid())
  avgResponseTime     Float    // milliseconds
  avgAIInferenceTime  Float    // milliseconds
  avgDbQueryTime      Float    // milliseconds
  errorRate           Float    // percentage
  requestCount        Int      // requests in time window
  memoryUsageMB       Float    // memory usage in MB
  cpuUsagePercent     Float    // CPU usage percentage
  health              String   // healthy, degraded, critical
  issues              Json     // list of detected issues
  metrics             Json     // detailed breakdown of all metrics
  timestamp           DateTime @default(now())

  @@index([health])
  @@index([timestamp])
  @@map("performance_snapshots")
}

// System logs - important system events persisted to database
model SystemLog {
  id          String   @id @default(cuid())
  level       String   // DEBUG, INFO, WARN, ERROR, CRITICAL
  category    String   // api_call, database_query, ai_inference, etc.
  message     String   @db.Text
  context     Json     // userId, conversationId, endpoint, etc.
  metadata    Json?    // stackTrace, errorCode, performance metrics
  timestamp   DateTime @default(now())

  @@index([level])
  @@index([category])
  @@index([timestamp])
  @@map("system_logs")
}

// ============================================================================
// PHASE 2: COGNITIVE MAP - Codebase Understanding
// ============================================================================

model CodebaseKnowledge {
  id             String   @id @default(cuid())
  filePath       String
  fileName       String
  layer          String   // 'api', 'services', 'database', 'ui', 'lib'
  functionCount  Int      @default(0)
  classCount     Int      @default(0)
  interfaceCount Int      @default(0)
  lineCount      Int      @default(0)
  complexity     Int      @default(0)
  imports        String[] // Array of imported files
  exports        String[] // Array of exported items
  lastAnalyzed   DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([layer])
  @@index([lastAnalyzed])
}

model ArchitectureSnapshot {
  id                  String   @id @default(cuid())
  totalFiles          Int
  totalFunctions      Int
  totalClasses        Int
  totalInterfaces     Int
  apiEndpoints        Int
  featureModules      Json     // Array of feature module data
  layers              Json     // Architecture layers data
  techStack           Json     // Technology stack data
  integrationPoints   Json     // External integration points
  timestamp           DateTime @default(now())

  @@index([timestamp])
}

model DependencyGraph {
  id                    String   @id @default(cuid())
  filePath              String   @unique
  directDependencies    String[] // Files this file directly imports
  directDependents      String[] // Files that directly import this file
  totalImpact           Int      @default(0) // Total files affected by changes
  isCritical            Boolean  @default(false)
  circularDependencies  String[] // Files involved in circular dependencies
  lastAnalyzed          DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([isCritical])
  @@index([lastAnalyzed])
}

// ============================================================================
// PHASE 3: ENHANCED SELF-AWARENESS & LEARNING
// ============================================================================

model CodeChange {
  id              String   @id @default(cuid())
  commitSha       String
  commitMessage   String   @db.Text
  authorName      String
  authorEmail     String
  branch          String   @default("main")
  filesChanged    Int      @default(0)
  additions       Int      @default(0)
  deletions       Int      @default(0)
  changedFiles    Json
  changeType      String
  impactScore     Float    @default(0)
  riskLevel       String   @default("low")
  affectedModules String[] @default([])
  committedAt     DateTime
  detectedAt      DateTime @default(now())
  analyzedAt      DateTime?
  healingActions  SelfHealingAction[]

  @@index([commitSha])
  @@index([branch])
  @@index([committedAt])
  @@index([riskLevel])
  @@map("code_changes")
}

model SelfHealingAction {
  id              String      @id @default(cuid())
  codeChangeId    String?
  codeChange      CodeChange? @relation(fields: [codeChangeId], references: [id], onDelete: SetNull)
  issueType       String
  severity        String
  description     String      @db.Text
  affectedFiles   String[]    @default([])
  healingType     String
  actionTaken     String      @db.Text
  changes         Json
  status          String      @default("pending")
  success         Boolean     @default(false)
  errorMessage    String?     @db.Text
  prUrl           String?
  prNumber        Int?
  prMerged        Boolean     @default(false)
  detectedAt      DateTime    @default(now())
  attemptedAt     DateTime?
  completedAt     DateTime?

  @@index([issueType])
  @@index([status])
  @@index([severity])
  @@index([detectedAt])
  @@map("self_healing_actions")
}

model PerformanceIssue {
  id              String   @id @default(cuid())
  endpoint        String
  issueType       String
  severity        String
  avgResponseTime Float
  p95ResponseTime Float?
  p99ResponseTime Float?
  requestCount    Int      @default(0)
  errorRate       Float?
  description     String   @db.Text
  stackTrace      String?  @db.Text
  query           String?  @db.Text
  recommendation  String   @db.Text
  status          String   @default("open")
  priority        Int      @default(5)
  resolved        Boolean  @default(false)
  firstDetected   DateTime @default(now())
  lastOccurred    DateTime @default(now())
  resolvedAt      DateTime?

  @@index([endpoint])
  @@index([issueType])
  @@index([severity])
  @@index([status])
  @@index([firstDetected])
  @@map("performance_issues")
}

model RefactoringRecommendation {
  id                  String   @id @default(cuid())
  filePath            String
  fileName            String
  codeSection         String?  @db.Text
  lineNumbers         Int[]    @default([])
  recommendationType  String
  severity            String
  priority            Int      @default(5)
  currentComplexity   Float?
  targetComplexity    Float?
  estimatedEffort     String
  benefits            String[] @default([])
  description         String   @db.Text
  reasoning           String   @db.Text
  suggestedApproach   String   @db.Text
  codeExample         String?  @db.Text
  status              String   @default("pending")
  implemented         Boolean  @default(false)
  effectiveness       Float?
  detectedAt          DateTime @default(now())
  acceptedAt          DateTime?
  completedAt         DateTime?

  @@index([filePath])
  @@index([recommendationType])
  @@index([status])
  @@index([priority])
  @@index([detectedAt])
  @@map("refactoring_recommendations")
}

model LearningInsight {
  id              String   @id @default(cuid())
  category        String
  insightType     String
  title           String
  description     String   @db.Text
  evidence        Json
  confidence      Float    @default(0.5)
  actionable      Boolean  @default(false)
  applied         Boolean  @default(false)
  priority        Int      @default(5)
  impact          String?
  relatedFiles    String[] @default([])
  relatedPatterns String[] @default([])
  tags            String[] @default([])
  learnedAt       DateTime @default(now())
  appliedAt       DateTime?
  validatedAt     DateTime?

  @@index([category])
  @@index([insightType])
  @@index([actionable])
  @@index([applied])
  @@index([learnedAt])
  @@map("learning_insights")
}

// ============================================
// PHASE 4A: AUTO-MERGE PR & PREDICTIVE DETECTION
// ============================================

model PullRequest {
  id                String    @id @default(cuid())
  prNumber          Int
  prUrl             String
  title             String
  description       String?   @db.Text
  branch            String
  baseBranch        String    @default("main")
  
  // Relations
  selfHealingId     String?
  selfHealingAction SelfHealingAction? @relation(fields: [selfHealingId], references: [id], onDelete: SetNull)
  
  // Auto-merge decision
  autoMergeable     Boolean   @default(false)
  safetyScore       Float     @default(0.0)
  riskFactors       String[]  @default([])
  checksStatus      String    @default("pending") // pending, passing, failing
  
  // Merge status
  status            String    @default("open") // open, merged, closed, rolled_back
  merged            Boolean   @default(false)
  mergedAt          DateTime?
  mergedBy          String?   @default("holly-auto-merge")
  rolledBack        Boolean   @default(false)
  rollbackReason    String?   @db.Text
  rolledBackAt      DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([prNumber])
  @@index([status])
  @@index([autoMergeable])
  @@index([selfHealingId])
  @@index([createdAt])
  @@map("pull_requests")
}

model Prediction {
  id                String    @id @default(cuid())
  predictionType    String    // performance_degradation, bug_risk, complexity_increase, security_vulnerability
  category          String    // code_quality, performance, security, maintainability
  
  // Target
  filePath          String
  fileName          String
  component         String?
  module            String?
  
  // Prediction details
  title             String
  description       String    @db.Text
  reasoning         String    @db.Text
  confidence        Float     @default(0.5) // 0.0 to 1.0
  severity          String    // critical, high, medium, low
  likelihood        Float     @default(0.5) // 0.0 to 1.0
  
  // Evidence
  indicators        Json      // Data that led to prediction
  patterns          String[]  @default([])
  historicalData    Json?
  
  // Recommendation
  recommendation    String    @db.Text
  preventionSteps   String[]  @default([])
  estimatedImpact   String?
  
  // Status
  status            String    @default("predicted") // predicted, monitoring, occurred, prevented, false_positive
  validated         Boolean   @default(false)
  validatedAt       DateTime?
  accuracy          Float?    // Set after validation
  
  // Timestamps
  predictedAt       DateTime  @default(now())
  monitorUntil      DateTime?
  occurredAt        DateTime?
  
  @@index([predictionType])
  @@index([status])
  @@index([confidence])
  @@index([severity])
  @@index([predictedAt])
  @@map("predictions")
}

model CodeQualityMetric {
  id                String    @id @default(cuid())
  
  // Scope
  scope             String    // file, module, project
  scopePath         String?
  scopeName         String?
  
  // Metrics
  linesOfCode       Int
  complexity        Int
  maintainability   Float     @default(0.0)
  testCoverage      Float     @default(0.0)
  
  // Quality scores
  qualityScore      Float     @default(0.0)
  duplication       Float     @default(0.0)
  documentation     Float     @default(0.0)
  
  // Issues
  bugs              Int       @default(0)
  vulnerabilities   Int       @default(0)
  codeSmells        Int       @default(0)
  
  // Tech debt
  technicalDebt     Int       @default(0) // Minutes
  debtRatio         Float     @default(0.0)
  
  // Trend data
  trend             String    @default("stable") // improving, stable, degrading
  changeFromPrev    Float     @default(0.0)
  
  measuredAt        DateTime  @default(now())
  
  @@index([scope])
  @@index([scopePath])
  @@index([qualityScore])
  @@index([measuredAt])
  @@map("code_quality_metrics")
}

model TechnicalDebt {
  id                String    @id @default(cuid())
  debtType          String    // code_smell, outdated_dependency, missing_test, poor_design
  category          String    // maintainability, reliability, security, performance
  
  // Location
  filePath          String
  fileName          String
  lineNumbers       Int[]     @default([])
  module            String?
  
  // Debt details
  title             String
  description       String    @db.Text
  impact            String    @db.Text
  
  // Effort estimation
  effortMinutes     Int       @default(0)
  severity          String    // critical, high, medium, low
  priority          Int       @default(5) // 1-10
  
  // Business impact
  affectedFeatures  String[]  @default([])
  userImpact        String?
  businessCost      String?
  
  // Remediation
  recommendation    String    @db.Text
  suggestedApproach String?   @db.Text
  
  // Status
  status            String    @default("identified") // identified, planned, in_progress, resolved
  resolved          Boolean   @default(false)
  resolvedAt        DateTime?
  
  identifiedAt      DateTime  @default(now())
  
  @@index([debtType])
  @@index([status])
  @@index([severity])
  @@index([priority])
  @@index([filePath])
  @@index([identifiedAt])
  @@map("technical_debt")
}

