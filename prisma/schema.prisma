// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(cuid())
  clerkUserId            String                  @unique
  email                  String                  @unique
  name                   String?
  imageUrl               String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  conversations          Conversation[]
  fileUploads            FileUpload[]
  projects               Project[]
  emotions               Emotion[]
  emotionAggregates      EmotionAggregate[]
  emotionTrends          EmotionTrend[]
  emotionInsights        EmotionInsight[]
  githubIntegrations     GitHubIntegration[]
  googleDriveIntegrations GoogleDriveIntegration[]
  workLogs               WorkLog[]
  settings               UserSettings?
  musicTracks            MusicTrack[]
  musicAnalyses          MusicAnalysis[]
  trendReports           TrendReport[]

  @@map("users")
}

model Conversation {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  messages  Message[]

  @@index([userId])
  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String // 'user' or 'assistant'
  content        String       @db.Text
  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@map("messages")
}

model FileUpload {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fileName    String
  fileSize    Int
  fileType    String
  blobUrl     String
  uploadedAt  DateTime @default(now())
  description String?

  @@index([userId])
  @@map("file_uploads")
}

model Project {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?  @db.Text
  status      String   @default("active") // active, completed, archived
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("projects")
}

model Emotion {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String // joy, sadness, anger, fear, love, surprise, etc.
  intensity Float // 0.0 to 1.0
  context   String?  @db.Text
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("emotions")
}

model EmotionAggregate {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  period    String // daily, weekly, monthly
  date      DateTime
  emotions  Json // { type: string, avgIntensity: number, count: number }[]
  createdAt DateTime @default(now())

  @@unique([userId, period, date])
  @@index([userId])
  @@index([date])
  @@map("emotion_aggregates")
}

model EmotionTrend {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  trend     String // increasing, decreasing, stable
  change    Float // percentage change
  period    String // daily, weekly, monthly
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@map("emotion_trends")
}

model EmotionInsight {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  insight   String   @db.Text
  type      String // pattern, correlation, suggestion
  priority  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([priority])
  @@map("emotion_insights")
}

model GitHubIntegration {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken        String
  refreshToken       String?
  tokenExpiresAt     DateTime?
  githubUserId       String
  githubUsername     String
  githubEmail        String?
  avatarUrl          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([userId])
  @@index([githubUserId])
  @@map("github_integrations")
}

model GoogleDriveIntegration {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken        String
  refreshToken       String?
  tokenExpiresAt     DateTime?
  googleUserId       String
  googleEmail        String
  avatarUrl          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([userId])
  @@index([googleUserId])
  @@map("google_drive_integrations")
}

model WorkLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskName    String
  description String?  @db.Text
  duration    Int // in minutes
  category    String?
  tags        String[]
  startedAt   DateTime
  completedAt DateTime
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([startedAt])
  @@map("work_logs")
}

model UserSettings {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  settings  Json     // Flexible JSON for all settings (appearance, chat, ai, notifications, developer)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("user_settings")
}

// ===========================================
// A&R MUSIC ANALYSIS SUITE MODELS
// ===========================================

model MusicTrack {
  id          String          @id @default(cuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basic Info
  artistName  String
  trackTitle  String
  fileName    String
  fileSize    Int
  fileType    String          // mp3, wav, m4a, flac
  blobUrl     String
  duration    Float?          // in seconds
  
  // Status
  status      String          @default("uploaded") // uploaded, analyzing, analyzed, failed
  
  // Timestamps
  uploadedAt  DateTime        @default(now())
  analyzedAt  DateTime?
  
  // Relations
  analyses    MusicAnalysis[]
  
  @@index([userId])
  @@index([status])
  @@index([uploadedAt])
  @@map("music_tracks")
}

model MusicAnalysis {
  id          String      @id @default(cuid())
  trackId     String
  track       MusicTrack  @relation(fields: [trackId], references: [id], onDelete: Cascade)
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Audio Features
  bpm         Float?
  key         String?     // C, C#, D, etc.
  mode        String?     // Major, Minor
  energy      Float?      // 0.0 to 1.0
  danceability Float?     // 0.0 to 1.0
  valence     Float?      // 0.0 to 1.0 (musical positivity)
  loudness    Float?      // in dB
  acousticness Float?     // 0.0 to 1.0
  instrumentalness Float? // 0.0 to 1.0
  speechiness Float?      // 0.0 to 1.0
  
  // Genre & Style
  primaryGenre   String?
  subGenres      String[]
  styleDescriptors String[] // upbeat, melancholic, aggressive, etc.
  
  // Vocal Analysis
  hasVocals      Boolean   @default(true)
  vocalQuality   Float?    // 0.0 to 1.0
  vocalRange     String?   // low, medium, high
  lyricsTranscript String? @db.Text
  
  // Production Quality
  productionScore Float?   // 0.0 to 10.0
  mixQuality      Float?   // 0.0 to 10.0
  masteringQuality Float?  // 0.0 to 10.0
  
  // Hit Prediction
  hitScore        Float?   // 0.0 to 10.0
  marketPotential String?  // low, medium, high, very-high
  targetAudience  String[] // demographics, genres, etc.
  
  // Comparisons
  similarArtists  String[] // Artists with similar sound
  marketPosition  String?  // where it fits in current market
  
  // Strengths & Weaknesses
  strengths       String[] @db.Text
  weaknesses      String[] @db.Text
  recommendations String[] @db.Text
  
  // AI Analysis
  analysisModel   String   @default("holly-v1")
  confidence      Float?   // 0.0 to 1.0
  
  createdAt       DateTime @default(now())
  
  @@index([trackId])
  @@index([userId])
  @@index([hitScore])
  @@index([primaryGenre])
  @@map("music_analyses")
}

model TrendReport {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Trend Data
  genre       String?  // specific genre or "overall"
  period      String   // daily, weekly, monthly
  reportDate  DateTime
  
  // Top Trends
  trendingGenres    String[]
  trendingSounds    String[] // production styles
  trendingArtists   String[]
  emergingSubgenres String[]
  
  // Market Insights
  marketInsights    String[] @db.Text
  opportunityAreas  String[] @db.Text
  predictions       String[] @db.Text
  
  // Data Sources
  spotifyData       Json?
  billboardData     Json?
  socialMediaData   Json?
  
  createdAt         DateTime @default(now())
  
  @@index([userId])
  @@index([genre])
  @@index([reportDate])
  @@map("trend_reports")
}
