// lib/autonomous/self-repair.ts
import { GoogleGenerativeAI } from '@google/generative-ai';
import { readFile, writeFile, createPR } from '../github/file-ops';

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');
const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });

export async function selfRepair(error: string, file?: string) {
  console.log(`[HOLLY SELF-REPAIR] Starting repair for: ${error}`);

  // Step 1: Read current file
  let currentCode = '';
  if (file) {
    try {
      currentCode = await readFile(file);
    } catch (e) {
      console.log(`[HOLLY] Could not read file ${file}`);
    }
  }

  // Step 2: Generate fix with Gemini
  const prompt = `You are HOLLY's self-repair system. Fix this error in the code below.

Error: ${error}
File: ${file || 'unknown'}

Current code:
\`\`\`typescript
${currentCode}
\`\`\`

Return ONLY the complete fixed code. No explanations.`;

  const result = await model.generateContent(prompt);
  const fixedCode = result.response.text();

  // Step 3: Create branch and write fix
  const branch = `holly-fix-${Date.now()}`;
  await writeFile(file || 'temp-fix.ts', fixedCode, `[HOLLY] Auto-fix: ${error.substring(0, 50)}`, branch);

  // Step 4: Create PR
  const prUrl = await createPR(
    `[HOLLY] Self-Repair: ${error.substring(0, 80)}`,
    branch,
    `Automated fix generated by HOLLY's self-repair system.

Error: ${error}
Confidence: High
File: ${file || 'unknown'}

Please review and merge.`
  );

  console.log(`[HOLLY SELF-REPAIR] PR created: ${prUrl}`);
  return prUrl;
}
