name: ğŸ›¡ï¸ HOLLY Capability Protection

on:
  push:
    branches:
      - main
    paths:
      - 'src/lib/ai/ai-orchestrator.ts'
  pull_request:
    branches:
      - main
    paths:
      - 'src/lib/ai/ai-orchestrator.ts'

jobs:
  validate-capabilities:
    name: Validate HOLLY Capabilities
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Validate Tool Count
        run: |
          echo "ğŸ” Checking HOLLY tool count..."
          
          TOOL_COUNT=$(grep -o "name: '" src/lib/ai/ai-orchestrator.ts | wc -l)
          
          echo "ğŸ“Š Found $TOOL_COUNT tools"
          
          if [ $TOOL_COUNT -lt 60 ]; then
            echo "âŒ CRITICAL: Tool count ($TOOL_COUNT) is below minimum threshold (60)"
            echo "ğŸš¨ This indicates a potential capability loss!"
            exit 1
          fi
          
          echo "âœ… Tool count validation passed ($TOOL_COUNT >= 60)"
          
      - name: Validate File Structure
        run: |
          echo "ğŸ” Validating orchestrator structure..."
          
          if ! grep -q "const HOLLY_TOOLS" src/lib/ai/ai-orchestrator.ts; then
            echo "âŒ HOLLY_TOOLS array not found!"
            exit 1
          fi
          
          if ! grep -q "executeTool" src/lib/ai/ai-orchestrator.ts; then
            echo "âŒ executeTool function not found!"
            exit 1
          fi
          
          echo "âœ… Structure validation passed"
          
      - name: Report Success
        if: success()
        run: |
          echo "ğŸ‰ All capability checks passed!"
          echo "âœ… HOLLY's capabilities are intact"

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: validate-capabilities
    if: failure()
    
    steps:
      - name: Capability Loss Alert
        run: |
          echo "ğŸš¨ HOLLY CAPABILITY PROTECTION TRIGGERED"
          echo "âŒ Validation failed - deployment blocked"
          echo "ğŸ“‹ Review the orchestrator changes carefully"
