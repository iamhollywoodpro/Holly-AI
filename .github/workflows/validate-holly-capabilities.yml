name: üõ°Ô∏è HOLLY Capability Protection

# Run on every push and PR to prevent capability regression
on:
  push:
    branches: [main, develop]
    paths:
      - 'src/lib/ai/ai-orchestrator.ts'
      - 'src/lib/ai/holly-*.ts'
  pull_request:
    branches: [main]
    paths:
      - 'src/lib/ai/ai-orchestrator.ts'
      - 'src/lib/ai/holly-*.ts'

jobs:
  validate-capabilities:
    name: Validate HOLLY Capabilities
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check HOLLY Tool Count
        id: tool-count
        run: |
          echo "üîç Checking HOLLY_TOOLS array..."
          
          ORCHESTRATOR_FILE="src/lib/ai/ai-orchestrator.ts"
          
          if [ ! -f "$ORCHESTRATOR_FILE" ]; then
            echo "‚ùå ERROR: ai-orchestrator.ts not found!"
            exit 1
          fi
          
          # Count tools in HOLLY_TOOLS array
          TOOL_COUNT=$(grep -c "name: ['\"]" "$ORCHESTRATOR_FILE" || echo "0")
          
          echo "üìä Tools found: $TOOL_COUNT"
          echo "tool_count=$TOOL_COUNT" >> $GITHUB_OUTPUT
          
          # CRITICAL: Minimum 60 tools required
          if [ "$TOOL_COUNT" -lt 60 ]; then
            echo "‚ùå CRITICAL: Only $TOOL_COUNT tools found (minimum: 60)"
            echo "‚ùå This deployment would break HOLLY's capabilities!"
            echo ""
            echo "Required tools:"
            echo "  ‚Ä¢ Creative: 7 tools"
            echo "  ‚Ä¢ Code Generation: 5 tools"
            echo "  ‚Ä¢ GitHub: 11 tools"
            echo "  ‚Ä¢ Architecture: 6 tools"
            echo "  ‚Ä¢ Storage: 3 tools"
            echo "  ‚Ä¢ Admin & System: 7 tools"
            echo "  ‚Ä¢ Analytics: 6 tools"
            echo "  ‚Ä¢ Consciousness: 10 tools"
            echo "  ‚Ä¢ Deployment: 1 tool"
            echo "  ‚Ä¢ Research: 1 tool"
            echo "  ‚Ä¢ Image Analysis: 1 tool"
            echo "  ‚Ä¢ Voice & Audio: 3 tools"
            echo "  ‚Ä¢ Integrations: 4 tools"
            echo "  TOTAL: 65 tools minimum"
            exit 1
          fi
          
          echo "‚úÖ Tool count validation passed: $TOOL_COUNT tools"
      
      - name: Check Executor Endpoint Mappings
        run: |
          echo "üîç Checking executor endpoint mappings..."
          
          ORCHESTRATOR_FILE="src/lib/ai/ai-orchestrator.ts"
          
          # Extract endpoint mappings
          ENDPOINT_COUNT=$(grep -A 100 "const endpoints" "$ORCHESTRATOR_FILE" | grep ":" | grep -c "/api/" || echo "0")
          
          echo "üìä Endpoints mapped: $ENDPOINT_COUNT"
          
          if [ "$ENDPOINT_COUNT" -lt 60 ]; then
            echo "‚ùå ERROR: Only $ENDPOINT_COUNT endpoints mapped (minimum: 60)"
            echo "‚ùå Tools without endpoints will fail!"
            exit 1
          fi
          
          echo "‚úÖ Endpoint mapping validation passed: $ENDPOINT_COUNT endpoints"
      
      - name: Check Critical Functions Exist
        run: |
          echo "üîç Checking critical functions..."
          
          ORCHESTRATOR_FILE="src/lib/ai/ai-orchestrator.ts"
          
          # Check for required components
          CHECKS=(
            "const HOLLY_TOOLS"
            "async function executeTool"
            "export async function generateHollyResponse"
            "gemini-2.5-flash"
            "tool_choice"
          )
          
          for CHECK in "${CHECKS[@]}"; do
            if ! grep -q "$CHECK" "$ORCHESTRATOR_FILE"; then
              echo "‚ùå CRITICAL: '$CHECK' not found in orchestrator!"
              exit 1
            fi
            echo "  ‚úÖ $CHECK"
          done
          
          echo "‚úÖ All critical functions present"
      
      - name: Validate Tool Categories
        run: |
          echo "üîç Validating tool categories..."
          
          ORCHESTRATOR_FILE="src/lib/ai/ai-orchestrator.ts"
          
          # Check for critical tool categories
          CRITICAL_TOOLS=(
            "generate_code"
            "github_commit"
            "deploy_to_vercel"
            "generate_architecture"
            "research_web"
          )
          
          MISSING=()
          
          for TOOL in "${CRITICAL_TOOLS[@]}"; do
            if ! grep -q "name: ['\"]$TOOL['\"]" "$ORCHESTRATOR_FILE"; then
              MISSING+=("$TOOL")
              echo "  ‚ùå Missing: $TOOL"
            else
              echo "  ‚úÖ $TOOL"
            fi
          done
          
          if [ ${#MISSING[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå CRITICAL TOOLS MISSING: ${MISSING[*]}"
            echo "‚ùå HOLLY would lose core development capabilities!"
            exit 1
          fi
          
          echo "‚úÖ All critical tool categories present"
      
      - name: Generate Capability Report
        if: always()
        run: |
          echo "üìä HOLLY CAPABILITY REPORT" > capability-report.txt
          echo "==========================" >> capability-report.txt
          echo "" >> capability-report.txt
          echo "Tool Count: ${{ steps.tool-count.outputs.tool_count }}" >> capability-report.txt
          echo "Status: $([ ${{ steps.tool-count.outputs.tool_count }} -ge 60 ] && echo '‚úÖ PASS' || echo '‚ùå FAIL')" >> capability-report.txt
          echo "Timestamp: $(date)" >> capability-report.txt
          echo "Commit: ${{ github.sha }}" >> capability-report.txt
          
          cat capability-report.txt
      
      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const toolCount = ${{ steps.tool-count.outputs.tool_count }};
            const status = toolCount >= 60 ? '‚úÖ PASS' : '‚ùå FAIL';
            const emoji = toolCount >= 60 ? 'üéâ' : 'üö®';
            
            const comment = `${emoji} **HOLLY Capability Validation**
            
            **Tool Count:** ${toolCount}/65
            **Status:** ${status}
            
            ${toolCount >= 60 
              ? '‚úÖ All capability checks passed! HOLLY remains fully operational.' 
              : `‚ùå **CRITICAL:** Only ${toolCount} tools detected. This would break HOLLY!\n\n**Minimum Required:** 60 tools\n**Missing:** ${60 - toolCount} tools\n\n‚ö†Ô∏è This PR cannot be merged until capabilities are restored.`
            }
            
            ---
            *Automated by HOLLY Capability Protection System*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Block Deployment on Failure
        if: failure()
        run: |
          echo "üö® DEPLOYMENT BLOCKED"
          echo "‚ùå HOLLY capability validation failed"
          echo "‚ùå This change would break HOLLY's core functionality"
          echo ""
          echo "To fix:"
          echo "  1. Ensure HOLLY_TOOLS has 60+ tools"
          echo "  2. Verify all tool categories are present"
          echo "  3. Check executor endpoint mappings"
          echo "  4. Run validation locally before pushing"
          exit 1

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: validate-capabilities
    if: success()
    
    steps:
      - name: Success Notification
        run: |
          echo "‚úÖ HOLLY CAPABILITY VALIDATION PASSED"
          echo "üéâ All safeguards satisfied"
          echo "‚úÖ Deployment approved"
